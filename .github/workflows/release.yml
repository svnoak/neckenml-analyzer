# Publish neckenml-core, neckenml-analyzer, and neckenml (meta) to PyPI.
# Each package has its own job for clearer errors and independent publishing.
# Configure trusted publishing for all three projects on PyPI.
#
# Versioning strategy (independent versions):
#   - core-v1.2.3    → publishes neckenml-core only
#   - analyzer-v1.0.0 → publishes neckenml-analyzer only
#   - v1.0.0         → publishes neckenml (meta) only
#   - release-v1.0.0 → publishes ALL packages (coordinated release)
#
# Bump neckenml (meta) when you want users to get new versions of deps.

name: Release to PyPI

on:
  push:
    tags:
      - 'v*'            # neckenml meta package only
      - 'core-v*'       # neckenml-core only
      - 'analyzer-v*'   # neckenml-analyzer only
      - 'release-v*'    # all packages (coordinated release)
  workflow_dispatch:
    inputs:
      package:
        description: 'Package(s) to release'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - neckenml-core
          - neckenml-analyzer
          - neckenml

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      publish_core: ${{ steps.resolve.outputs.core }}
      publish_analyzer: ${{ steps.resolve.outputs.analyzer }}
      publish_neckenml: ${{ steps.resolve.outputs.neckenml }}
    steps:
      - name: Resolve which packages to publish
        id: resolve
        run: |
          TAG="${{ github.ref_name }}"
          CHOICE="${{ github.event.inputs.package }}"

          if [ -n "$CHOICE" ]; then
            case "$CHOICE" in
              all)
                echo "core=true" >> $GITHUB_OUTPUT
                echo "analyzer=true" >> $GITHUB_OUTPUT
                echo "neckenml=true" >> $GITHUB_OUTPUT
                ;;
              neckenml-core)
                echo "core=true" >> $GITHUB_OUTPUT
                ;;
              neckenml-analyzer)
                echo "analyzer=true" >> $GITHUB_OUTPUT
                ;;
              neckenml)
                echo "neckenml=true" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            case "$TAG" in
              core-v*)
                echo "core=true" >> $GITHUB_OUTPUT
                ;;
              analyzer-v*)
                echo "analyzer=true" >> $GITHUB_OUTPUT
                ;;
              release-v*)
                echo "core=true" >> $GITHUB_OUTPUT
                echo "analyzer=true" >> $GITHUB_OUTPUT
                echo "neckenml=true" >> $GITHUB_OUTPUT
                ;;
              v*)
                echo "neckenml=true" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

  publish-core:
    needs: resolve
    if: needs.resolve.outputs.publish_core == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build neckenml-core
        run: |
          pip install build
          cd packages/neckenml-core && python -m build
      - name: Publish neckenml-core to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/neckenml-core/dist/

  publish-analyzer:
    needs: resolve
    if: needs.resolve.outputs.publish_analyzer == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build neckenml-analyzer
        run: |
          pip install build
          cd packages/neckenml-analyzer && python -m build
      - name: Publish neckenml-analyzer to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/neckenml-analyzer/dist/

  publish-neckenml:
    needs: [resolve, publish-core, publish-analyzer]
    # Run if neckenml is requested AND any triggered sibling jobs succeeded (or were skipped)
    if: |
      always() &&
      needs.resolve.outputs.publish_neckenml == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build neckenml
        run: |
          pip install build
          cd packages/neckenml && python -m build
      - name: Publish neckenml to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/neckenml/dist/

  notify:
    needs: [publish-core, publish-analyzer, publish-neckenml]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Release Summary
        run: |
          echo "## NeckenML PyPI Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| neckenml-core | ${{ needs.publish-core.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| neckenml-analyzer | ${{ needs.publish-analyzer.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| neckenml | ${{ needs.publish-neckenml.result }} |" >> $GITHUB_STEP_SUMMARY
